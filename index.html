<!DOCTYPE>
<html>
    <head>
        <meta charset="utf-8">
        <title>Weather Heater</title>
        <link rel="stylesheet" type="text/css" href="style.css">
        <script type="text/javascript" src="http://d3js.org/d3.v3.min.js"></script>
    </head>
    <body>
        <nav><ul></ul></nav>
        <div id="container">
            <header><h1><h1></header>
        </div>
        <script type="text/javascript">
        (function() {
            var width = 960, height = 320;
            var margin = { top: 40, right: 40, bottom: 20, left: 120 };

            // Settings for data lines.
            var yRanges = [[height, 0], [0, height], [height, 0]];
            var yAxisOrients = ['right', 'left', 'left'];
            var yAxisOffsets = [width, 0, -30];
            var fields = ['uv', 'hum', 'temp'];
            var units = ['紫外線', '濕度%', '溫度℃'];

            // Initialize svg graph.
            var svg = d3.select('div#container')
                .append('svg')
                .attr('width', margin.left + width + margin.right)
                .attr('height', margin.top + height + margin.bottom)
                .append('g')
                .attr('transform', 'translate(' + margin.left + ', ' + margin.top + ')');

            // Initialize x/y axes.
            var x = d3.time.scale()
                .range([0, width]);
            var y = yRanges.map(function(range) {
                return d3.scale.linear()
                    .range(range);
            });

            var xAxis = d3.svg.axis()
                .scale(x)
                .orient('bottom');
            var yAxis = yAxisOrients.map(function(orient, i) {
                return d3.svg.axis()
                    .scale(y[i])
                    .orient(orient);
            });

            var line = fields.map(function(field, i) {
                return d3.svg.line()
                    .x(function(d) { return x(d.time); })
                    .y(function(d) { return y[i](d[field]); });
            });

            svg.append('g')
                .attr('class', 'axis x')
                .attr('transform', 'translate(0, ' + height + ')');

            fields.forEach(function(field, i) {
                svg.append('g')
                    .attr('class', 'axis y ' + field)
                    .attr('transform', 'translate(' + yAxisOffsets[i] + ', 0)')
                   .append('text')
                    .text(units[i])
                    .attr('transform', 'translate(' + (-15 * (i + 1)) + ', -15)')
                svg.append('path')
                    .attr('class', 'line ' + field);
            });

            var parseDate = d3.time.format("%Y-%m-%d %H").parse;

            var draw = function(place) {
                d3.json('api.php?place=' + place, function(data) {
                    // Set title.
                    d3.select('h1').text(place);

                    // Set invalid data as zero and remove empty data.
                    data = data
                        .map(function(d) {
                            d.time = parseDate(d.time_by_hour);
                            d.uv = d.uv? d.uv : 0;
                            d.hum = d.hum? d.hum : 0;
                            d.temp = d.temp? d.temp : 0;
                            return d;
                        })
                        .filter(function(d) {
                            return d.uv || d.hum || d.temp;
                        });

                    // Update x/y data.
                    x.domain(d3.extent(data, function(d) { return d.time; }));
                    svg.select('g.axis.x')
                        .transition()
                        .duration(1000)
                        .call(xAxis);

                    fields.forEach(function(field, i) {
                        y[i].domain(d3.extent(data, function(d) { return d[field]; }));
                        svg.select('g.axis.y.' + field)
                            .transition()
                            .duration(1000)
                            .call(yAxis[i]);
                        svg.select('path.line.' + field)
                            .datum(data)
                            .transition()
                            .duration(1000)
                            .attr('d', line[i]);
                    });
                });
            };

            // Generate list for weather stations.
            d3.json('api.php', function(error, data) {
                d3.select('nav>ul').selectAll('li')
                    .data(data)
                    .enter()
                    .append('li')
                    .text(function(d) { return d; })
                    .on('click', function(d, i) {
                        draw(d);
                    });

                d3.select('nav>ul>li').on('click')(data[0], 0);
            });
        })();
        </script>
    </body>
</html>
