<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Magic Circle</title>
        <link rel="stylesheet" type="text/css" href="circleStyle.css">
        <script type="text/javascript" src="http://d3js.org/d3.v3.min.js"></script>
    </head>
    <body>
        <div id="form">
            <input id="place" type="text" autocomplete="off">
            <button id="submit" type="submit">Add</button>
            <input id="range" type="range" min="0" max="10" step="0.5" value="1.5">
            <button id="hide" type="button">Hide</button>
        </div>
        <div id="container"></div>
        <script type="text/javascript">
        (function() {
            var width = 640, height = 640, scaledHeight = 200;
            var margin = { top: 20, right: 20, bottom: 20, left: 20 };

            var centerX = width / 2, centerY = height / 2, innerCircleRadius = 80;
            var yRanges = [[0, scaledHeight], [scaledHeight, 0], [0, scaledHeight]];
            var fields = ['uv', 'hum', 'temp'];

            // Initialize x/y axes.
            var x = d3.time.scale()
                .range([0, width]);
            var y = yRanges.map(function(range) {
                return d3.scale.linear()
                    .range(range);
            });

            var line = fields.map(function(field, i) {
                return d3.svg.line()
                    .x(function(d) {
                        return (y[i](d[field]) + innerCircleRadius) *
                            Math.cos(((x(d.time) - x.range()[0]) / (x.range()[1] - x.range()[0]) - 0.25) * Math.PI * 2);
                    })
                    .y(function(d) {
                        return (y[i](d[field]) + innerCircleRadius) *
                            Math.sin(((x(d.time) - x.range()[0]) / (x.range()[1] - x.range()[0]) - 0.25) * Math.PI * 2);
                    });
            });

            var linearLine = d3.svg.line()
                .x(function(d) { return d.x; })
                .y(function(d) { return d.y; })
                .interpolate('linear');

            var parseDate = d3.time.format('%Y-%m-%d %H').parse;
            var oneWeekBefore = new Date(new Date().setDate(new Date().getDate() - 7));

            var newSvg = function(place) {
                var svg = d3.select('div#container')
                    .append('svg')
                    .attr('width', margin.left + width + margin.right)
                    .attr('height', margin.top + height + margin.bottom);

                var g = svg.append('g');
                fields.forEach(function(field, i) {
                    g.append('path')
                        .attr('class', 'line ' + field);
                });

                // Generate start date line.
                g.append('path')
                    .attr('class', 'line date-line')
                    .attr('d', linearLine([
                        { x: 0, y: - innerCircleRadius - scaledHeight },
                        { x: 0, y: - innerCircleRadius }
                    ]));

                // Generate inner line.
                svg.append('circle')
                    .attr('class', 'line inner')
                    .attr('cx', centerX)
                    .attr('cy', centerY)
                    .attr('r', innerCircleRadius);

                // Generate outer line.
                svg.append('circle')
                    .attr('class', 'line outer')
                    .attr('cx', centerX)
                    .attr('cy', centerY)
                    .attr('r', innerCircleRadius + scaledHeight);

                d3.json('api.php?place=' + place, function(error, data) {
                    // Set invalid data as zero.
                    data = data
                        .map(function(d) {
                            d.time = parseDate(d.time_by_hour);
                            d.uv = d.uv? d.uv : 0;
                            d.hum = d.hum? d.hum : 0;
                            d.temp = d.temp? d.temp : 0;
                            return d;
                        })
                        .filter(function(d) {
                            return d.time.getTime() > oneWeekBefore.getTime(); 
                        });

                    // Update x/y data.
                    x.domain(d3.extent(data, function(d) { return d.time; }));

                    fields.forEach(function(field, i) {
                        y[i].domain(d3.extent(data, function(d) { return d[field]; }));
                        g.select('path.line.' + field)
                            .datum(data)
                            .transition()
                            .duration(1000)
                            .attr('d', line[i]);
                    });

                    var lineWidth = d3.select('input#range').property('value');
                    svg.selectAll('.line')
                        .style('stroke-width', lineWidth);

                    // Set timer for rotation.
                    var centerRadius = Math.sqrt(centerX * centerX + centerY * centerY);
                    var start = Date.now();

                    d3.timer(function() {
                        var elapsed = Date.now() - start;
                        var degree = Math.floor(0.02 * elapsed);
                        var rotate = function(d) {
                            var dx = centerX - centerRadius * Math.cos(degree + Math.PI * 0.25),
                                dy = centerY - centerRadius * Math.sin(degree + Math.PI * 0.25);
                            return 'rotate(' + degree + ')';
                        };

                        g
                            .attr('transform', 'translate(' + centerX + ',' + centerY + ')')
                            .selectAll('path')
                            .attr('transform', rotate);
                    });
                });
            };

            // Form settings.
            d3.select('button#submit').on('click', function() {
                var place = d3.select('input#place').property('value');
                newSvg(place);
            });

            d3.select('input#range').on('change', function() {
                var lineWidth = d3.select(this).property('value');
                d3.selectAll('.line')
                    .style('stroke-width', lineWidth);
            });

            d3.select('button#hide').on('click', function() {
                d3.select('div#form')
                    .style('display', 'none');
            });

            d3.select('body').on('keydown', function() {
                var evt = d3.event;
                // key 'h' pressed down
                if(evt.keyCode == 72) {
                    var form = d3.select('div#form');
                    var display = form.style('display');
                    if(display == 'none')
                        form.style('display', 'inherit');
                    else
                        form.style('display', 'none');
                }
            });
        })();
        </script>
    </body>
</html>
